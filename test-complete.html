<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Enhancer - Complete Test Suite</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h2 {
            color: #2c3e50;
            margin-top: 0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .credentials {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background-color: #4CAF50;
        }
        .status-offline {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 AI Prompt Enhancer - Complete Test Suite</h1>
        
        <!-- Backend Status -->
        <div class="test-section">
            <h2>🔧 Backend Status</h2>
            <div class="test-item">
                <p>
                    <span id="apiStatus" class="status-indicator status-offline"></span>
                    <span id="apiStatusText">Flask API: Checking...</span>
                </p>
                <p>
                    <span id="streamlitStatus" class="status-indicator status-offline"></span>
                    <span id="streamlitStatusText">Streamlit Admin: Checking...</span>
                </p>
                <button onclick="checkBackendStatus()">🔄 Refresh Status</button>
                <div id="statusResult" class="result"></div>
            </div>
        </div>

        <!-- API Tests -->
        <div class="test-section">
            <h2>🔌 API Endpoint Tests</h2>
            <div class="test-grid">
                <!-- Registration Test -->
                <div class="test-item">
                    <h3>📝 Registration</h3>
                    <input type="text" id="regName" placeholder="Name" value="Test User">
                    <input type="email" id="regEmail" placeholder="Email" value="testuser@example.com">
                    <textarea id="regReason" placeholder="Reason" rows="2">Testing the complete integration system</textarea>
                    <button onclick="testRegistration()">Register User</button>
                    <div id="regResult" class="result"></div>
                </div>

                <!-- Verification Test -->
                <div class="test-item">
                    <h3>✅ Verification</h3>
                    <input type="email" id="verEmail" placeholder="Email" value="john@example.com">
                    <input type="text" id="verCode" placeholder="Redemption Code" value="SLSAH1NA">
                    <button onclick="testVerification()">Verify Code</button>
                    <div id="verResult" class="result"></div>
                </div>

                <!-- Credit Check Test -->
                <div class="test-item">
                    <h3>🪙 Credit Check</h3>
                    <input type="text" id="creditCode" placeholder="Redemption Code" value="SLSAH1NA">
                    <button onclick="testCreditCheck()">Check Credits</button>
                    <div id="creditResult" class="result"></div>
                </div>

                <!-- Enhancement Test -->
                <div class="test-item">
                    <h3>🎯 Prompt Enhancement</h3>
                    <input type="text" id="enhanceCode" placeholder="Redemption Code" value="SLSAH1NA">
                    <textarea id="enhancePrompt" placeholder="Prompt to enhance" rows="3">Write a Python function to calculate fibonacci sequence</textarea>
                    <button onclick="testEnhancement()">Enhance Prompt</button>
                    <div id="enhanceResult" class="result"></div>
                </div>
            </div>
        </div>

        <!-- Test Credentials -->
        <div class="test-section">
            <h2>🔑 Test Credentials</h2>
            <div class="credentials">
                <p><strong>Test User:</strong></p>
                <p>📧 Email: john@example.com</p>
                <p>🎫 Redemption Code: SLSAH1NA</p>
                <p>💰 Credits: <span id="testUserCredits">Loading...</span></p>
                <button onclick="refreshTestCredits()">🔄 Refresh Credits</button>
            </div>
        </div>

        <!-- Extension Integration -->
        <div class="test-section">
            <h2>🧩 Extension Integration Test</h2>
            <div class="test-item">
                <h3>📱 Extension Detection</h3>
                <p id="extensionStatus">Checking for extension...</p>
                <button onclick="checkExtension()">🔍 Check Extension</button>
                
                <h3>💾 LocalStorage Test</h3>
                <button onclick="setTestCredentials()">Set Test Credentials</button>
                <button onclick="clearCredentials()">Clear Credentials</button>
                <div id="storageResult" class="result"></div>

                <h3>🔗 Cross-Tab Communication</h3>
                <p>This simulates the extension importing credentials from this page:</p>
                <button onclick="simulateExtensionImport()">Import to Extension</button>
                <div id="importResult" class="result"></div>
            </div>
        </div>

        <!-- Workflow Test -->
        <div class="test-section">
            <h2>🔄 Complete Workflow Test</h2>
            <div class="test-item">
                <h3>End-to-End Flow</h3>
                <p>This tests the complete user journey:</p>
                <ol>
                    <li>Registration → Waiting List</li>
                    <li>Admin Approval → Redemption Code</li>
                    <li>Code Verification → Active Account</li>
                    <li>Extension Usage → Credit Deduction</li>
                </ol>
                <button onclick="runCompleteWorkflow()">🚀 Run Complete Test</button>
                <div id="workflowResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        const STREAMLIT_URL = 'http://localhost:8501';

        // Check backend status
        async function checkBackendStatus() {
            // Check Flask API
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    document.getElementById('apiStatus').className = 'status-indicator status-online';
                    document.getElementById('apiStatusText').textContent = 'Flask API: Online ✅';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                document.getElementById('apiStatus').className = 'status-indicator status-offline';
                document.getElementById('apiStatusText').textContent = 'Flask API: Offline ❌';
            }

            // Check Streamlit
            try {
                const response = await fetch(STREAMLIT_URL);
                if (response.ok) {
                    document.getElementById('streamlitStatus').className = 'status-indicator status-online';
                    document.getElementById('streamlitStatusText').textContent = 'Streamlit Admin: Online ✅';
                } else {
                    throw new Error('Streamlit not responding');
                }
            } catch (error) {
                document.getElementById('streamlitStatus').className = 'status-indicator status-offline';
                document.getElementById('streamlitStatusText').textContent = 'Streamlit Admin: Offline ❌';
            }
        }

        // Test registration
        async function testRegistration() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const reason = document.getElementById('regReason').value;
            const resultDiv = document.getElementById('regResult');

            try {
                const params = new URLSearchParams({ name, email, reason });
                const response = await fetch(`${API_URL}/api/register?${params}`);
                const result = await response.json();
                
                resultDiv.className = result.success ? 'result success' : 'result error';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Test verification
        async function testVerification() {
            const email = document.getElementById('verEmail').value;
            const code = document.getElementById('verCode').value;
            const resultDiv = document.getElementById('verResult');

            try {
                const params = new URLSearchParams({ email, code });
                const response = await fetch(`${API_URL}/api/verify?${params}`);
                const result = await response.json();
                
                resultDiv.className = result.success ? 'result success' : 'result error';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Test credit check
        async function testCreditCheck() {
            const code = document.getElementById('creditCode').value;
            const resultDiv = document.getElementById('creditResult');

            try {
                const params = new URLSearchParams({ redemption_code: code });
                const response = await fetch(`${API_URL}/api/check_credits?${params}`);
                const result = await response.json();
                
                resultDiv.className = result.success ? 'result success' : 'result error';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Test enhancement
        async function testEnhancement() {
            const code = document.getElementById('enhanceCode').value;
            const prompt = document.getElementById('enhancePrompt').value;
            const resultDiv = document.getElementById('enhanceResult');

            try {
                const response = await fetch(`${API_URL}/api/enhance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        redemption_code: code,
                        prompt: prompt,
                        settings: {
                            role: 'a helpful programming assistant',
                            description: 'detailed',
                            length: 'medium',
                            format: 'structured',
                            tone: 'helpful'
                        }
                    })
                });
                const result = await response.json();
                
                resultDiv.className = result.success ? 'result success' : 'result error';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Refresh test credits
        async function refreshTestCredits() {
            try {
                const params = new URLSearchParams({ redemption_code: 'SLSAH1NA' });
                const response = await fetch(`${API_URL}/api/check_credits?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('testUserCredits').textContent = `${result.remaining_credits}/${result.total_credits}`;
                } else {
                    document.getElementById('testUserCredits').textContent = 'Error loading';
                }
            } catch (error) {
                document.getElementById('testUserCredits').textContent = 'Error loading';
            }
        }

        // Check extension
        function checkExtension() {
            const statusDiv = document.getElementById('extensionStatus');
            
            if (typeof browser !== 'undefined' || typeof chrome !== 'undefined') {
                statusDiv.innerHTML = '✅ Extension environment detected!';
                statusDiv.className = 'result success';
            } else {
                statusDiv.innerHTML = '❌ No extension environment found. This is normal when testing in browser.';
                statusDiv.className = 'result info';
            }
        }

        // Set test credentials in localStorage
        function setTestCredentials() {
            localStorage.setItem('ai_enhancer_email', 'john@example.com');
            localStorage.setItem('ai_enhancer_code', 'SLSAH1NA');
            localStorage.setItem('ai_enhancer_verified', 'true');
            
            document.getElementById('storageResult').textContent = '✅ Test credentials set in localStorage';
            document.getElementById('storageResult').className = 'result success';
        }

        // Clear credentials
        function clearCredentials() {
            localStorage.removeItem('ai_enhancer_email');
            localStorage.removeItem('ai_enhancer_code');
            localStorage.removeItem('ai_enhancer_verified');
            
            document.getElementById('storageResult').textContent = '🧹 Credentials cleared from localStorage';
            document.getElementById('storageResult').className = 'result info';
        }

        // Simulate extension import
        function simulateExtensionImport() {
            const email = localStorage.getItem('ai_enhancer_email');
            const code = localStorage.getItem('ai_enhancer_code');
            const verified = localStorage.getItem('ai_enhancer_verified');
            
            const resultDiv = document.getElementById('importResult');
            
            if (email && code && verified) {
                resultDiv.textContent = `📥 Extension would import:\nEmail: ${email}\nCode: ${code}\nVerified: ${verified}`;
                resultDiv.className = 'result success';
            } else {
                resultDiv.textContent = '❌ No credentials found to import. Set test credentials first.';
                resultDiv.className = 'result error';
            }
        }

        // Run complete workflow test
        async function runCompleteWorkflow() {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.className = 'result info';
            resultDiv.textContent = 'Starting complete workflow test...\n\n';
            
            const log = (message) => {
                resultDiv.textContent += message + '\n';
            };
            
            try {
                // Step 1: Register new user
                log('1. Testing registration...');
                const randomEmail = `test${Date.now()}@example.com`;
                const regResponse = await fetch(`${API_URL}/api/register?name=Test%20Workflow&email=${randomEmail}&reason=Workflow%20test`);
                const regResult = await regResponse.json();
                
                if (regResult.success) {
                    log('✅ Registration successful');
                } else {
                    throw new Error(`Registration failed: ${regResult.message}`);
                }
                
                // Step 2: Check existing verified user
                log('2. Testing verification with existing user...');
                const verResponse = await fetch(`${API_URL}/api/verify?email=john@example.com&code=SLSAH1NA`);
                const verResult = await verResponse.json();
                
                if (verResult.success) {
                    log(`✅ Verification successful for ${verResult.name}`);
                } else {
                    throw new Error(`Verification failed: ${verResult.message}`);
                }
                
                // Step 3: Check credits
                log('3. Testing credit check...');
                const creditResponse = await fetch(`${API_URL}/api/check_credits?redemption_code=SLSAH1NA`);
                const creditResult = await creditResponse.json();
                
                if (creditResult.success) {
                    log(`✅ Credit check successful: ${creditResult.remaining_credits} credits remaining`);
                } else {
                    throw new Error(`Credit check failed: ${creditResult.message}`);
                }
                
                // Step 4: Test enhancement
                log('4. Testing prompt enhancement...');
                const enhanceResponse = await fetch(`${API_URL}/api/enhance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        redemption_code: 'SLSAH1NA',
                        prompt: 'Test workflow prompt',
                        settings: { role: 'assistant', description: 'brief' }
                    })
                });
                const enhanceResult = await enhanceResponse.json();
                
                if (enhanceResult.success) {
                    log(`✅ Enhancement successful: ${enhanceResult.remaining_credits} credits remaining`);
                } else {
                    throw new Error(`Enhancement failed: ${enhanceResult.message}`);
                }
                
                log('\n🎉 Complete workflow test PASSED! All systems working correctly.');
                resultDiv.className = 'result success';
                
            } catch (error) {
                log(`\n❌ Workflow test FAILED: ${error.message}`);
                resultDiv.className = 'result error';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendStatus();
            refreshTestCredits();
            checkExtension();
        });
    </script>
</body>
</html>
